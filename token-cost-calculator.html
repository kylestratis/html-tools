<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Token Cost Calculator - HTML Tools</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        :root {
            /* Tool-specific colors */
            --bg-gradient-start: #667eea;
            --bg-gradient-end: #764ba2;
            --input-bg: #ffffff;
            --result-bg: #f0f4ff;
            --result-border: #d0d8ff;
            --warning-bg: #fff3cd;
            --warning-border: #ffc107;
            --warning-text: #856404;
            --success-bg: #d4edda;
            --success-border: #28a745;
            --success-text: #155724;
        }

        body.dark-mode {
            /* Tool-specific dark mode colors */
            --bg-gradient-start: #1a1a2e;
            --bg-gradient-end: #16213e;
            --input-bg: #2d2d2d;
            --result-bg: #2a2a3e;
            --result-border: #404060;
            --warning-bg: #3d3420;
            --warning-border: #ffc107;
            --warning-text: #ffdb6d;
            --success-bg: #1e3a28;
            --success-border: #28a745;
            --success-text: #7dcea0;
        }

        body {
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .settings-button {
            position: fixed;
            top: 20px;
            right: 100px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 20px;
            box-shadow: 0 2px 10px var(--shadow);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .settings-button:hover {
            transform: scale(1.05);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px var(--shadow);
            transition: background-color 0.3s ease;
        }

        h1 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 2.5em;
            transition: color 0.3s ease;
        }

        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 1.1em;
            transition: color 0.3s ease;
        }

        label {
            display: block;
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 600;
            transition: color 0.3s ease;
        }

        textarea {
            width: 100%;
            min-height: 250px;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            resize: vertical;
            margin-bottom: 20px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            background: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        input[type="password"]:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        select {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            background: var(--input-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .results {
            background: var(--result-bg);
            border: 2px solid var(--result-border);
            border-radius: 10px;
            padding: 25px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .result-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .result-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .result-label {
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.95em;
            transition: color 0.3s ease;
        }

        .result-value {
            color: var(--text-primary);
            font-size: 1.3em;
            font-weight: 700;
            transition: color 0.3s ease;
        }

        .result-value.cost {
            color: var(--accent-primary);
            font-size: 1.5em;
        }

        .token-method {
            font-size: 0.75em;
            color: var(--text-secondary);
            font-weight: normal;
            margin-left: 8px;
        }

        .info {
            background: var(--bg-primary);
            border-left: 4px solid var(--accent-primary);
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            color: var(--text-secondary);
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .warning {
            background: var(--warning-bg);
            border-left: 4px solid var(--warning-border);
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            color: var(--warning-text);
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .success {
            background: var(--success-bg);
            border-left: 4px solid var(--success-border);
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            color: var(--success-text);
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .model-details {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
            font-size: 0.85em;
            color: var(--text-secondary);
        }

        .pricing-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .pricing-item {
            background: var(--bg-primary);
            padding: 8px;
            border-radius: 5px;
        }

        .pricing-label {
            font-size: 0.75em;
            color: var(--text-secondary);
            margin-bottom: 3px;
        }

        .pricing-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px var(--shadow);
            transition: background-color 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: var(--text-primary);
            font-size: 1.5em;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }

        .close-button:hover {
            color: var(--text-primary);
        }

        .button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 10px;
        }

        .button-primary {
            background: var(--accent-primary);
            color: white;
        }

        .button-primary:hover {
            background: var(--accent-secondary);
        }

        .button-secondary {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .button-secondary:hover {
            opacity: 0.8;
        }

        .button-danger {
            background: #dc3545;
            color: white;
        }

        .button-danger:hover {
            background: #c82333;
        }

        .modal-buttons {
            display: flex;
            margin-top: 20px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .settings-button {
                top: 10px;
                right: 80px;
                padding: 8px 16px;
                font-size: 18px;
            }

            .pricing-info {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <button class="settings-button" id="settingsButton" aria-label="Settings">‚öôÔ∏è</button>
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
        <span class="theme-icon">üåô</span>
    </button>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="close-button" id="closeModal">&times;</button>
            </div>
            <div>
                <label for="anthropicKey">Anthropic API Key (Optional)</label>
                <input
                    type="password"
                    id="anthropicKey"
                    placeholder="sk-ant-..."
                    autocomplete="off"
                />
                <div class="info" style="margin-top: 10px; margin-bottom: 20px;">
                    <strong>üîí Privacy:</strong> Your API key is stored only in your browser's localStorage and never sent anywhere except directly to Anthropic's API for token counting. It's never transmitted to any other server.
                </div>
                <div class="info" style="margin-top: 10px; margin-bottom: 20px;">
                    <strong>‚ÑπÔ∏è Why provide an API key?</strong> With an Anthropic API key, Claude models will use exact token counts instead of estimates. This is free (subject to rate limits). OpenAI models use TikToken for accurate counting without an API key.
                </div>
                <div class="modal-buttons">
                    <button class="button button-primary" id="saveApiKey">Save</button>
                    <button class="button button-danger" id="clearApiKey">Clear</button>
                    <button class="button button-secondary" id="cancelModal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>ü§ñ AI Token Cost Calculator</h1>
        <p class="subtitle">Calculate token count and cost for your AI prompts</p>

        <label for="promptText">Enter your prompt:</label>
        <textarea
            id="promptText"
            placeholder="Paste or type your prompt here...&#10;&#10;This tool calculates the number of tokens and cost based on the selected AI model's input token pricing."
        ></textarea>

        <label for="modelSelect">Select AI Model:</label>
        <select id="modelSelect">
            <optgroup label="OpenAI">
                <option value="gpt-4o">GPT-4o</option>
                <option value="gpt-4o-mini">GPT-4o-mini</option>
                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                <option value="gpt-4">GPT-4</option>
                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
            </optgroup>
            <optgroup label="Anthropic Claude">
                <option value="claude-opus-4">Claude Opus 4</option>
                <option value="claude-sonnet-4">Claude Sonnet 4</option>
                <option value="claude-3.5-sonnet">Claude 3.5 Sonnet</option>
                <option value="claude-3-opus">Claude 3 Opus</option>
                <option value="claude-3-haiku">Claude 3 Haiku</option>
            </optgroup>
            <optgroup label="Google Gemini">
                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
            </optgroup>
            <optgroup label="Meta">
                <option value="llama-3.3-70b">Llama 3.3 70B</option>
                <option value="llama-3.1-405b">Llama 3.1 405B</option>
            </optgroup>
            <optgroup label="Mistral">
                <option value="mistral-large">Mistral Large</option>
                <option value="mistral-small">Mistral Small</option>
            </optgroup>
        </select>

        <div class="results" id="results">
            <div class="result-row">
                <span class="result-label">Character Count:</span>
                <span class="result-value" id="charCount">0</span>
            </div>
            <div class="result-row">
                <span class="result-label">
                    Token Count:
                    <span class="token-method" id="tokenMethod"></span>
                </span>
                <span class="result-value" id="tokenCount">0</span>
            </div>
            <div class="result-row">
                <span class="result-label">Cost (Input):</span>
                <span class="result-value cost" id="costValue">$0.00000</span>
            </div>
            <div class="model-details" id="modelDetails">
                <div class="pricing-info">
                    <div class="pricing-item">
                        <div class="pricing-label">Input Price</div>
                        <div class="pricing-value" id="inputPrice">-</div>
                    </div>
                    <div class="pricing-item">
                        <div class="pricing-label">Output Price</div>
                        <div class="pricing-value" id="outputPrice">-</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="statusMessage"></div>

        <div class="info">
            <strong>‚ÑπÔ∏è About Token Counting:</strong><br>
            ‚Ä¢ <strong>OpenAI models:</strong> Accurate counts using TikToken<br>
            ‚Ä¢ <strong>Claude models:</strong> Exact counts via API (if key provided) or estimates<br>
            ‚Ä¢ <strong>Other models:</strong> Estimates using 4:1 character-to-token ratio<br><br>
            <strong>Pricing:</strong> Current as of December 2024 (per million tokens)
        </div>
    </div>

    <!-- Load js-tiktoken from CDN -->
    <script type="module">
        import { Tiktoken } from 'https://cdn.jsdelivr.net/npm/js-tiktoken@1.0.14/+esm';

        // AI Model pricing data (input/output per 1M tokens)
        const modelPricing = {
            'gpt-4o': { input: 2.50, output: 10.00, name: 'GPT-4o', encoding: 'o200k_base', apiModel: 'claude-opus-4' },
            'gpt-4o-mini': { input: 0.15, output: 0.60, name: 'GPT-4o-mini', encoding: 'o200k_base', apiModel: 'claude-opus-4' },
            'gpt-4-turbo': { input: 10.00, output: 30.00, name: 'GPT-4 Turbo', encoding: 'cl100k_base', apiModel: 'claude-opus-3' },
            'gpt-4': { input: 30.00, output: 60.00, name: 'GPT-4', encoding: 'cl100k_base', apiModel: 'claude-opus-3' },
            'gpt-3.5-turbo': { input: 0.50, output: 1.50, name: 'GPT-3.5 Turbo', encoding: 'cl100k_base', apiModel: 'claude-opus-3' },
            'claude-opus-4': { input: 15.00, output: 75.00, name: 'Claude Opus 4', apiModel: 'claude-opus-4' },
            'claude-sonnet-4': { input: 3.00, output: 15.00, name: 'Claude Sonnet 4', apiModel: 'claude-sonnet-4' },
            'claude-3.5-sonnet': { input: 3.00, output: 15.00, name: 'Claude 3.5 Sonnet', apiModel: 'claude-3-5-sonnet-20241022' },
            'claude-3-opus': { input: 15.00, output: 75.00, name: 'Claude 3 Opus', apiModel: 'claude-3-opus-20240229' },
            'claude-3-haiku': { input: 0.25, output: 1.25, name: 'Claude 3 Haiku', apiModel: 'claude-3-haiku-20240307' },
            'gemini-1.5-pro': { input: 1.25, output: 5.00, name: 'Gemini 1.5 Pro' },
            'gemini-1.5-flash': { input: 0.075, output: 0.30, name: 'Gemini 1.5 Flash' },
            'gemini-2.0-flash': { input: 0.10, output: 0.40, name: 'Gemini 2.0 Flash' },
            'llama-3.3-70b': { input: 0.35, output: 0.40, name: 'Llama 3.3 70B' },
            'llama-3.1-405b': { input: 0.80, output: 0.80, name: 'Llama 3.1 405B' },
            'mistral-large': { input: 2.00, output: 6.00, name: 'Mistral Large' },
            'mistral-small': { input: 0.20, output: 0.60, name: 'Mistral Small' }
        };

        // DOM elements
        const promptText = document.getElementById('promptText');
        const modelSelect = document.getElementById('modelSelect');
        const charCount = document.getElementById('charCount');
        const tokenCount = document.getElementById('tokenCount');
        const tokenMethod = document.getElementById('tokenMethod');
        const costValue = document.getElementById('costValue');
        const inputPrice = document.getElementById('inputPrice');
        const outputPrice = document.getElementById('outputPrice');
        const statusMessage = document.getElementById('statusMessage');

        // Settings modal
        const settingsButton = document.getElementById('settingsButton');
        const settingsModal = document.getElementById('settingsModal');
        const closeModal = document.getElementById('closeModal');
        const cancelModal = document.getElementById('cancelModal');
        const saveApiKey = document.getElementById('saveApiKey');
        const clearApiKey = document.getElementById('clearApiKey');
        const anthropicKeyInput = document.getElementById('anthropicKey');

        // Load saved API key
        const savedApiKey = localStorage.getItem('anthropic_api_key');
        if (savedApiKey) {
            anthropicKeyInput.value = savedApiKey;
        }

        // Modal handlers
        settingsButton.addEventListener('click', () => {
            settingsModal.classList.add('show');
        });

        closeModal.addEventListener('click', () => {
            settingsModal.classList.remove('show');
        });

        cancelModal.addEventListener('click', () => {
            settingsModal.classList.remove('show');
        });

        saveApiKey.addEventListener('click', () => {
            const key = anthropicKeyInput.value.trim();
            if (key) {
                localStorage.setItem('anthropic_api_key', key);
                showStatus('‚úÖ API key saved! Claude models will now use exact token counts.', 'success');
            } else {
                localStorage.removeItem('anthropic_api_key');
                showStatus('‚ÑπÔ∏è API key removed. Using estimates for Claude models.', 'info');
            }
            settingsModal.classList.remove('show');
            updateCalculations();
        });

        clearApiKey.addEventListener('click', () => {
            anthropicKeyInput.value = '';
            localStorage.removeItem('anthropic_api_key');
            showStatus('‚ÑπÔ∏è API key cleared. Using estimates for Claude models.', 'info');
            settingsModal.classList.remove('show');
            updateCalculations();
        });

        // Click outside modal to close
        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('show');
            }
        });

        // Show status message
        function showStatus(message, type = 'info', autoClear = true) {
            const className = type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            statusMessage.innerHTML = `<div class="${className}">${message}</div>`;
            if (autoClear) {
                setTimeout(() => {
                    statusMessage.innerHTML = '';
                }, 5000);
            }
        }

        // TikToken encoders cache
        let encoders = {};

        // Get or create TikToken encoder
        async function getEncoder(encoding) {
            if (!encoders[encoding]) {
                encoders[encoding] = new Tiktoken(encoding);
            }
            return encoders[encoding];
        }

        // Count tokens using TikToken (for OpenAI models)
        async function countTokensWithTiktoken(text, encoding) {
            try {
                const encoder = await getEncoder(encoding);
                const tokens = encoder.encode(text);
                return tokens.length;
            } catch (error) {
                console.error('TikToken error:', error);
                return estimateTokens(text);
            }
        }

        // Count tokens using Anthropic API
        async function countTokensWithAnthropic(text, modelId) {
            const apiKey = localStorage.getItem('anthropic_api_key');
            if (!apiKey) {
                return null; // No API key, use estimate
            }

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages/count_tokens', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-beta': 'token-counting-2024-11-01'
                    },
                    body: JSON.stringify({
                        model: modelId,
                        messages: [
                            {
                                role: 'user',
                                content: text
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showStatus('‚ö†Ô∏è Invalid Anthropic API key. Using estimates.', 'warning');
                        localStorage.removeItem('anthropic_api_key');
                    } else {
                        console.error('Anthropic API error:', response.status);
                    }
                    return null;
                }

                const data = await response.json();
                return data.input_tokens;
            } catch (error) {
                console.error('Anthropic API error:', error);
                return null;
            }
        }

        // Estimate token count (fallback method)
        function estimateTokens(text) {
            if (!text) return 0;
            // Simple estimation: ~4 characters per token
            return Math.ceil(text.length / 4);
        }

        // Calculate cost based on token count and model
        function calculateCost(tokens, modelKey) {
            const model = modelPricing[modelKey];
            if (!model) return 0;
            return (tokens * model.input) / 1000000;
        }

        // Format cost with appropriate precision
        function formatCost(cost) {
            if (cost === 0) return '$0.00000';

            // For very small costs, show maximum precision to avoid scientific notation
            // unless it would be too long for display (more than ~20 characters)
            if (cost < 0.000001) {
                // Try showing with 10 decimal places
                const formatted = `$${cost.toFixed(10)}`;
                // If the string is too long (would wrap), use scientific notation
                if (formatted.length > 20) {
                    return `$${cost.toExponential(2)}`;
                }
                return formatted;
            }
            if (cost < 0.00001) return `$${cost.toFixed(8)}`;
            if (cost < 0.0001) return `$${cost.toFixed(7)}`;
            if (cost < 0.001) return `$${cost.toFixed(6)}`;
            if (cost < 0.01) return `$${cost.toFixed(5)}`;
            if (cost < 1) return `$${cost.toFixed(4)}`;
            return `$${cost.toFixed(2)}`;
        }

        // Main calculation function
        async function updateCalculations() {
            const text = promptText.value;
            const selectedModel = modelSelect.value;
            const model = modelPricing[selectedModel];

            if (!model) return;

            // Character count
            const chars = text.length;
            charCount.textContent = chars.toLocaleString();

            // Token count - use appropriate method based on model
            let tokens = 0;
            let method = '';

            if (model.encoding) {
                // OpenAI model - use TikToken
                tokens = await countTokensWithTiktoken(text, model.encoding);
                method = '(TikToken)';
            } else if (model.apiModel) {
                // Claude model - try API, fallback to estimate
                const apiTokens = await countTokensWithAnthropic(text, model.apiModel);
                if (apiTokens !== null) {
                    tokens = apiTokens;
                    method = '(Anthropic API)';
                } else {
                    tokens = estimateTokens(text);
                    method = '(Estimated)';
                }
            } else {
                // Other models - use estimate
                tokens = estimateTokens(text);
                method = '(Estimated)';
            }

            tokenCount.textContent = tokens.toLocaleString();
            tokenMethod.textContent = method;

            // Cost
            const cost = calculateCost(tokens, selectedModel);
            costValue.textContent = formatCost(cost);

            // Model pricing details
            inputPrice.textContent = `$${model.input.toFixed(2)}/1M tokens`;
            outputPrice.textContent = `$${model.output.toFixed(2)}/1M tokens`;

            // Show Anthropic API key suggestion if using estimates for Anthropic models
            if (model.apiModel && method === '(Estimated)') {
                showStatus('üí° <strong>Tip:</strong> For exact token counts with Claude models, add your Anthropic API key via the ‚öôÔ∏è settings button.', 'info', false);
            } else {
                // Clear the tip if we're not using Anthropic estimates
                statusMessage.innerHTML = '';
            }
        }

        // Event listeners
        promptText.addEventListener('input', updateCalculations);
        modelSelect.addEventListener('change', updateCalculations);

        // Initialize
        updateCalculations();
    </script>
    <script src="theme.js"></script>
</body>
</html>
